# Copyright 2021-2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Add new vSwitch and portgroup to ESXi host and deploy a router VM
# Parameters:
#   vm_arch: the architecture of ESXi server on which the VM deployed,
#     valid value are 'x86', 'arm64'
#   router_vm_name: the name of router VM which is used to assign
#     DHCP IP to new network interface.
#   vswitch_name: the name of vSwitch to be added for new network
#     interface testing or GOSC testing.
#   portgroup_name: the name of vSwitch portgroup to be added for
#     new network interface testing or GOSC testing.
#
- name: Set fact of the variables deploying router VM required
  set_fact:
    router_vm_name: "Ansible_Router_VM_{{ testrun_timestamp }}"
    vswitch_name: "vSwitch{{ testrun_timestamp }}"
    portgroup_name: "vSwitch{{ testrun_timestamp }}_PG"
    vlan_gateway: "192.168.192.1"

- name: Set fact of the OpenWrt template used
  set_fact:
    router_vm_ovf_path: "{{ main_playbook_path }}/tools/openwrt_19.07.2_x86.ova"
    router_vm_new_nic: "e1000"
  when: vm_arch is undefined or vm_arch == 'x86'
- name: Set fact of the OpenWrt template used
  set_fact:
    router_vm_ovf_path: "{{ main_playbook_path }}/tools/openwrt_19.07.7_amd64.ova"
    router_vm_new_nic: "vmxnet3"
  when: vm_arch is defined and vm_arch == 'arm64'

# Add a new standard vSwitch without physical network adapters
- include_tasks: esxi_add_vswitch.yml

# Create a new portgroup for VM network
- include_tasks: esxi_add_portgroup.yml

# Deploy a router VM
- include_tasks: router_vm_deploy.yml

# Hotadd a new e1000 network adapter to router VM
- include_tasks: vm_add_network_adapter.yml
  vars:
    adapter_type: "{{ router_vm_new_nic }}"
    vm_name: "{{ router_vm_name }}"

# Power on the router VM
- include_tasks: vm_set_power_state.yml
  vars:
    vm_power_state_set: 'powered-on'
    vm_name: "{{ router_vm_name }}"
- name: "Wait 20 seconds to let router VM start up"
  pause:
    seconds: 20

- name: "Set fact of router_vm_deployed to True"
  set_fact:
    router_vm_deployed: True
