# Copyright 2021-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# For hot add sata disk test, set the boot disk label first since
# boot order may be changed after hot-add disk.
# For hot add nvme disk test, get nvme boot disk controller info first
# since there is hot adding disk to nvme boot disk controller test.
#
- name: "Get VM boot disk and controller info"
  include_tasks: get_vm_boot_disk_info.yml
  when:
    - boot_disk_info_retrieved is undefined
    - (test_disk_controller_type == 'sata' and vm_firmware == 'bios' and win_boot_disk_ctl_type not in ['ide', 'sata']) or
      (test_disk_controller_type == 'nvme' and win_boot_disk_ctl_type == 'nvme')

- name: "Get new disk controller bus number"
  include_tasks: ../../common/vm_get_new_vhba_bus_number.yml
  vars:
    disk_controller_facts_data: "{{ disk_controllers_before_hotadd }}"
    new_vhba_type: "{{ disk_controller }}"

- name: "Enable NVMe spec 1.3"
  include_tasks: enable_vm_nvme_spec13.yml
  when:
    - test_disk_controller_type == 'nvme'
    - test_purpose in ["hot-add-spec13", "hot-extend"]
